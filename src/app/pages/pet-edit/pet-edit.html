<main class="pet-edit">
  <header class="topbar">
    <div class="left">
      <button type="button" aria-label="Back" (click)="onBack()">&#8592;</button>
      <h1>{{ isCreateMode() ? 'Add Pet Profile' : 'Edit Pet Profile' }}</h1>
    </div>
    <button
      type="button"
      class="confirm"
      aria-label="Confirm"
      (click)="onSave()"
      [disabled]="!canSubmitSave()"
    >
      &#10003;
    </button>
  </header>

  @if (loading()) {
    <section class="content">
      <div class="panel-message">Ladowanie danych zwierzaka...</div>
    </section>
  } @else if (loadError()) {
    <section class="content">
      <div class="panel-message error">
        Nie udalo sie zaladowac widoku edycji. Sprobuj ponownie za chwile.
      </div>
    </section>
  } @else {
    <section class="content">
      <section class="photo-section">
        <div class="photo-wrap">
          <div class="photo">
            @if (photoSrc()) {
              <img [src]="photoSrc()!" alt="Pet photo" />
            } @else {
              <div class="photo-placeholder">No Photo</div>
            }
          </div>
          <input
            #photoInput
            type="file"
            accept="image/*"
            class="hidden-file-input"
            (change)="onPhotoSelected($event)"
          />
          <button
            type="button"
            class="camera-btn"
            aria-label="Change photo"
            (click)="photoInput.click()"
            [disabled]="uploadingPhoto() || isCreateMode()"
          >
            {{ uploadingPhoto() ? 'â€¦' : 'ðŸ“·' }}
          </button>
        </div>
        <p>{{ isCreateMode() ? 'Photo after create' : 'Change Photo' }}</p>
      </section>

      <form class="form" [formGroup]="form" (ngSubmit)="onSave()">
        <div class="field">
          <label for="petName">Pet Name</label>
          <input id="petName" type="text" placeholder="Enter pet name" formControlName="name" />
          @if (isInvalid('name')) {
            <p class="inline-error">Name jest wymagane (max 120 znakow).</p>
          }
        </div>

        <div class="field">
          <label for="breedId">Breed</label>
          <div class="select-wrap">
            <select id="breedId" formControlName="breedId">
              <option [ngValue]="0" disabled>Select breed</option>
              @for (breed of breeds(); track breed.id) {
                <option [ngValue]="breed.id">{{ breed.name }}</option>
              }
            </select>
            <span>â–¾</span>
          </div>
          @if (isInvalid('breedId')) {
            <p class="inline-error">Wybierz rase.</p>
          }
        </div>

        <div class="field">
          <label>Gender</label>
          <div class="gender-toggle">
            <button
              type="button"
              [class.active]="form.controls.gender.value === 'MALE'"
              (click)="onSelectGender('MALE')"
            >
              Male
            </button>
            <button
              type="button"
              [class.active]="form.controls.gender.value === 'FEMALE'"
              (click)="onSelectGender('FEMALE')"
            >
              Female
            </button>
          </div>
        </div>

        <div class="field">
          <label for="dateOfBirth">Date of Birth</label>
          <div class="readonly-input">
            <input id="dateOfBirth" type="date" formControlName="dateOfBirth" />
            <span>ðŸ“…</span>
          </div>
        </div>

        <section class="device-card">
          <h2>Device Management</h2>

          <div class="inner">
            <div class="field compact">
              <label for="assignedDeviceId">Assigned Tracker</label>
              <div class="select-wrap">
                <select
                  id="assignedDeviceId"
                  formControlName="assignedDeviceId"
                  [disabled]="deviceSelectLocked()"
                >
                  <option [ngValue]="null">Unassigned</option>
                  @for (device of devices(); track device.id) {
                    <option [ngValue]="device.id">
                      {{ deviceOptionLabel(device) }}
                      @if (device.businessId) {
                        ({{ device.businessId }})
                      }
                    </option>
                  }
                </select>
                <span>â–¾</span>
              </div>
            </div>

            <div class="info">
              <span>i</span>
              <p>
                Tracker moze byc przypisany tylko do jednego zwierzaka naraz. Backend automatycznie
                przepnie tracker miedzy Twoimi zwierzakami, ale odrzuci przypisanie do cudzego peta.
              </p>
            </div>
          </div>
        </section>

        @if (!isCreateMode()) {
          <section class="danger-zone">
            <button
              type="button"
              class="danger-btn"
              (click)="onDelete()"
              [disabled]="deleting() || saving()"
            >
              {{ deleting() ? 'Removing...' : 'Remove Pet Profile' }}
            </button>
          </section>
        }
      </form>
    </section>

    <footer class="footer-actions">
      <button
        type="button"
        class="save-btn"
        (click)="onSave()"
        [disabled]="!canSubmitSave()"
      >
        {{ saving() ? 'Saving...' : (isCreateMode() ? 'Create Pet' : 'Save Changes') }}
      </button>
    </footer>
  }
</main>
