<main class="main-view">
  <section class="map-layer">
    <app-map
      class="map-canvas"
      [latitude]="mapLatitude()"
      [longitude]="mapLongitude()"
      [petName]="currentPetName()"
      [live]="isLive()"
      (zoomChanged)="onMapZoomChanged($event)"
    />
    <div class="map-layer-overlay"></div>

    <div class="header-overlay">
      <button type="button" class="circle">‚ò∞</button>
      <div class="header-actions">
        <button type="button" class="circle">üîî</button>
        <button type="button" class="circle">‚öô</button>
      </div>
    </div>

    @if (!loading() && currentPet() && !hasMapPosition()) {
      <div class="pet-marker">
        <div class="avatar">
          <div class="pulse"></div>
          @if (currentPhotoSrc()) {
            <img [src]="currentPhotoSrc()!" [alt]="currentPetName()" />
          } @else {
            <div class="avatar-fallback">{{ petAvatarLetter() }}</div>
          }
          <span class="dot" [class.dot-offline]="!isLive()"></span>
        </div>
        <p>{{ markerCaption() }}</p>
      </div>
    }
  </section>

  <div class="fab-stack">
    <button type="button" class="fab-btn" (click)="recenterMap()" aria-label="Center on pet">‚óé</button>

    @if (!zoomPanelCollapsed()) {
      <div class="zoom-widget" aria-label="Map zoom controls">
        <div class="zoom-widget-head">
          <span class="zoom-widget-title">Zoom</span>
          <button
            type="button"
            class="zoom-widget-toggle"
            (click)="collapseZoomPanel()"
            aria-label="Hide zoom controls"
          >
            ‚Ä∫
          </button>
        </div>

        <button type="button" class="fab-btn zoom-btn" (click)="zoomMapIn()" aria-label="Zoom in">Ôºã</button>

        <div class="zoom-track">
          <div class="zoom-scale">
            <span></span>
            <span></span>
            <span></span>
            <span></span>
            <span></span>
          </div>
          <button
            type="button"
            class="zoom-track-hit"
            (click)="onZoomTrackClick($event)"
            aria-label="Set zoom level"
          >
            <span class="zoom-fill" [style.height.%]="100 - zoomThumbTopPercent()"></span>
            <span class="zoom-thumb" [style.top.%]="zoomThumbTopPercent()"></span>
          </button>
          <div class="zoom-value">{{ mapZoom() }}</div>
        </div>

        <button type="button" class="fab-btn zoom-btn" (click)="zoomMapOut()" aria-label="Zoom out">Ôºç</button>
      </div>
    } @else {
      <button
        type="button"
        class="zoom-widget-collapsed"
        (click)="expandZoomPanel()"
        aria-label="Show zoom controls"
        title="Show zoom"
      >
        <span class="zoom-widget-collapsed-icon">Ôºã</span>
        <span class="zoom-widget-collapsed-arrow">‚Äπ</span>
      </button>
    }
  </div>

  <section class="sheet" [class.sheet-collapsed]="sheetCollapsed()">
    @if (!sheetCollapsed()) {
      <div class="sheet-topline">
        <div class="handle"></div>
        <button type="button" class="sheet-toggle" (click)="collapseSheet()" aria-label="Collapse panel">
          <span aria-hidden="true">‚ñæ</span>
        </button>
      </div>

      @if (loading()) {
        <div class="sheet-loading">Loading map data...</div>
      } @else if (loadError()) {
        <div class="sheet-error">
          Nie udalo sie zaladowac danych mapy. Sprobuj odswiezyc ekran.
        </div>
      } @else if (!currentPet()) {
        <div class="sheet-empty">
          <h2>No pets yet</h2>
          <p>Dodaj pierwszego zwierzaka, aby zobaczyc dane na ekranie mapy.</p>
        </div>
      } @else {
        <div class="sheet-head">
          <div>
            <h2>{{ currentPetName() }}</h2>
            <p>{{ petSubtitle() }}</p>
          </div>
          <span class="live" [class.live-offline]="!isLive()">{{ liveLabel() }}</span>
        </div>

        <div class="stats">
          <article>
            <h3>{{ batteryLabel() }}</h3>
            <p>Battery</p>
          </article>
          <article>
            <h3>{{ statusLabel() }}</h3>
            <p>Status</p>
          </article>
          <article>
            <h3>{{ updatedLabel() }}</h3>
            <p>Updated</p>
          </article>
        </div>

        <div class="detail">
          <div>
            <h4>{{ detailTitle() }}</h4>
            <p>{{ detailCoordsLabel() }}</p>
          </div>
          <div class="speed">{{ speedLabel() }}</div>
        </div>
      }

      <div class="quick-actions">
        <button type="button">History</button>
        <button type="button">Light</button>
        <button type="button">Sound</button>
        <button type="button" class="go">Go</button>
      </div>
    } @else {
      <div class="sheet-collapsed-bar">
        <div class="sheet-collapsed-meta">
          <strong>{{ currentPet() ? currentPetName() : 'Map' }}</strong>
          <span>{{ currentPet() ? liveLabel() : 'Overview' }}</span>
        </div>
        <button type="button" class="sheet-toggle" (click)="expandSheet()" aria-label="Expand panel">
          <span aria-hidden="true">‚ñ¥</span>
        </button>
      </div>
    }

    <nav class="bottom-nav">
      <a
        routerLink="/main-view-map"
        routerLinkActive="active"
        [routerLinkActiveOptions]="{ exact: true }"
        class="nav-item"
      >
        <span class="nav-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24">
            <path
              d="M15 5.6 9 3 3 5v15.4l6-2.4 6 2.4 6-2.4V3.6L15 6Zm0 2.1 4-1.6v10.6l-4 1.6V7.7Zm-10-.6 4-1.6v10.8l-4 1.6V7.1Zm6 9.1V5.4l2 .8v10.8l-2-.8Z"
              fill="currentColor"
            />
          </svg>
        </span>
        <span class="nav-label">Map</span>
      </a>
      <a [routerLink]="profileLink()" routerLinkActive="active" class="nav-item">
        <span class="nav-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24">
            <path
              d="M8.4 9.8c1 0 1.8-1.2 1.8-2.7S9.4 4.4 8.4 4.4 6.6 5.6 6.6 7.1s.8 2.7 1.8 2.7Zm7.2 0c1 0 1.8-1.2 1.8-2.7s-.8-2.7-1.8-2.7-1.8 1.2-1.8 2.7.8 2.7 1.8 2.7ZM5.2 15.4c1.3 0 2.3-1.4 2.3-3.2S6.5 9 5.2 9s-2.3 1.4-2.3 3.2 1 3.2 2.3 3.2Zm13.6 0c1.3 0 2.3-1.4 2.3-3.2S20.1 9 18.8 9s-2.3 1.4-2.3 3.2 1 3.2 2.3 3.2Zm-6.8-1.1c-2.5 0-4.7 1.5-4.7 3.6 0 1.8 1.6 2.7 4.7 2.7s4.7-.9 4.7-2.7c0-2.1-2.2-3.6-4.7-3.6Z"
              fill="currentColor"
            />
          </svg>
        </span>
        <span class="nav-label">Pets</span>
      </a>
      <a class="nav-item" aria-disabled="true">
        <span class="nav-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24">
            <path
              d="M4 19h16v2H4v-2Zm1-2V9h3v8H5Zm5 0V5h3v12h-3Zm5 0v-6h3v6h-3Z"
              fill="currentColor"
            />
          </svg>
        </span>
        <span class="nav-label">Activity</span>
      </a>
      <a routerLink="/pets" routerLinkActive="active" class="nav-item">
        <span class="nav-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24">
            <path
              d="M12 12c2.2 0 4-1.8 4-4s-1.8-4-4-4-4 1.8-4 4 1.8 4 4 4Zm0 2c-4 0-7 2-7 4.5V21h14v-2.5C19 16 16 14 12 14Z"
              fill="currentColor"
            />
          </svg>
        </span>
        <span class="nav-label">Profile</span>
      </a>
    </nav>
  </section>
</main>
