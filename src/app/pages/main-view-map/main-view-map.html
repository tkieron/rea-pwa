<main class="main-view">
  <section class="map-layer">
    <app-map class="map-canvas" [latitude]="mapLatitude()" [longitude]="mapLongitude()" [petName]="currentPetName()"
      [live]="isLive()" (zoomChanged)="onMapZoomChanged($event)" />
    <div class="map-layer-overlay"></div>

    <div class="header-overlay">
      <button type="button" class="circle">‚ò∞</button>
      <div class="header-actions">
        <button type="button" class="circle">üîî</button>
        <button type="button" class="circle">‚öô</button>
      </div>
    </div>

    @if (!loading() && currentPet() && !hasMapPosition()) {
    <div class="pet-marker">
      <div class="avatar">
        <div class="pulse"></div>
        @if (currentPhotoSrc()) {
        <img [src]="currentPhotoSrc()!" [alt]="currentPetName()" />
        } @else {
        <div class="avatar-fallback">{{ petAvatarLetter() }}</div>
        }
        <span class="dot" [class.dot-offline]="!isLive()"></span>
      </div>
      <p>{{ markerCaption() }}</p>
    </div>
    }
  </section>

  <div class="fab-stack">
    @if (!zoomPanelCollapsed()) {
    <div class="zoom-widget" aria-label="Map controls">
      <div class="zoom-widget-head">
        <span class="zoom-widget-title">Map</span>
        <button type="button" class="zoom-widget-toggle" (click)="collapseZoomPanel()" aria-label="Hide map controls">
          ‚Ä∫
        </button>
      </div>

      <button type="button" class="fab-btn zoom-btn" (click)="recenterMap()" aria-label="Center on pet">‚óé</button>
      <div class="zoom-divider"></div>

      <button type="button" class="fab-btn zoom-btn" (click)="zoomMapIn()" aria-label="Zoom in">Ôºã</button>

      <div class="zoom-track">
        <div class="zoom-scale">
          <span></span>
          <span></span>
          <span></span>
          <span></span>
          <span></span>
        </div>
        <button type="button" class="zoom-track-hit" (click)="onZoomTrackClick($event)" aria-label="Set zoom level">
          <span class="zoom-fill" [style.height.%]="100 - zoomThumbTopPercent()"></span>
          <span class="zoom-thumb" [style.top.%]="zoomThumbTopPercent()"></span>
        </button>
        <div class="zoom-value">{{ mapZoom() }}</div>
      </div>

      <button type="button" class="fab-btn zoom-btn" (click)="zoomMapOut()" aria-label="Zoom out">Ôºç</button>
    </div>
    } @else {
    <div class="zoom-widget-collapsed-container">
      <button type="button" class="fab-btn" (click)="recenterMap()" aria-label="Center on pet">‚óé</button>
      <button type="button" class="zoom-widget-collapsed" (click)="expandZoomPanel()" aria-label="Show map controls"
        title="Show zoom">
        <span class="zoom-widget-collapsed-icon">Ôºã</span>
        <span class="zoom-widget-collapsed-arrow">‚Äπ</span>
      </button>
    </div>
    }
  </div>

  <section class="sheet" [class.sheet-collapsed]="sheetCollapsed()">
    @if (!sheetCollapsed()) {
    <div class="sheet-topline">
      <div class="handle"></div>
      <button type="button" class="sheet-toggle" (click)="collapseSheet()" aria-label="Collapse panel">
        <span aria-hidden="true">‚ñæ</span>
      </button>
    </div>

    @if (loading()) {
    <div class="sheet-loading">Loading map data...</div>
    } @else if (loadError()) {
    <div class="sheet-error">
      Nie udalo sie zaladowac danych mapy. Sprobuj odswiezyc ekran.
    </div>
    } @else if (!currentPet()) {
    <div class="sheet-empty">
      <h2>No pets yet</h2>
      <p>Dodaj pierwszego zwierzaka, aby zobaczyc dane na ekranie mapy.</p>
    </div>
    } @else {
    <div class="sheet-head">
      <div>
        <h2>{{ currentPetName() }}</h2>
        <p>{{ petSubtitle() }}</p>
      </div>
      <span class="live" [class.live-offline]="!isLive()">{{ liveLabel() }}</span>
    </div>

    <div class="stats">
      <article>
        <h3>{{ batteryLabel() }}</h3>
        <p>Battery</p>
      </article>
      <article>
        <h3>{{ statusLabel() }}</h3>
        <p>Status</p>
      </article>
      <article>
        <h3>{{ updatedLabel() }}</h3>
        <p>Updated</p>
      </article>
    </div>

    <div class="detail">
      <div>
        <h4>{{ detailTitle() }}</h4>
        <p>{{ detailCoordsLabel() }}</p>
      </div>
      <div class="speed">{{ speedLabel() }}</div>
    </div>
    }

    <div class="quick-actions">
      <button type="button">History</button>
      <button type="button">Light</button>
      <button type="button">Sound</button>
      <button type="button" class="go">Go</button>
    </div>
    } @else {
    <div class="sheet-collapsed-bar">
      <div class="sheet-collapsed-meta">
        <strong>{{ currentPet() ? currentPetName() : 'Map' }}</strong>
        <span>{{ currentPet() ? liveLabel() : 'Overview' }}</span>
      </div>
      <button type="button" class="sheet-toggle" (click)="expandSheet()" aria-label="Expand panel">
        <span aria-hidden="true">‚ñ¥</span>
      </button>
    </div>
    }

    <nav class="bottom-nav">
      <a routerLink="/main-view-map" routerLinkActive="active-nav" [routerLinkActiveOptions]="{exact: true}"
        class="nav-item">
        <span class="material-symbols-outlined">map</span>
        <span>Map</span>
      </a>
      <a routerLink="/pets" routerLinkActive="active-nav" [routerLinkActiveOptions]="{exact: true}" class="nav-item">
        <span class="material-symbols-outlined">pets</span>
        <span>Pets</span>
      </a>
      <a routerLink="/activity" class="nav-item">
        <span class="material-symbols-outlined">monitoring</span>
        <span>Activity</span>
      </a>
      <a [routerLink]="profileLink()" routerLinkActive="active-nav" class="nav-item">
        <span class="material-symbols-outlined">person</span>
        <span>Profile</span>
      </a>
    </nav>
  </section>
</main>